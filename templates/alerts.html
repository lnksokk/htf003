{% extends "base.html" %}

{% block head %}
<title>Alerts - Patient Early-Warning System</title>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Patient Alerts</h1>
        <p class="text-muted">Showing all vital sign threshold violations</p>
    </div>
    <div class="col-auto">
        <span class="badge bg-danger">
            <span id="alert-count">{{ alerts|length }}</span> Total Alerts
        </span>
    </div>
</div>

<div id="alerts-container">
    <div class="card">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <strong>Time</strong>
                </div>
                <div class="col-md-2">
                    <strong>Patient</strong>
                </div>
                <div class="col-md-2">
                    <strong>Vital Sign</strong>
                </div>
                <div class="col-md-2">
                    <strong>Value</strong>
                </div>
                <div class="col-md-2">
                    <strong>Threshold</strong>
                </div>
                <div class="col-md-2">
                    <strong>Actions</strong>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if alerts %}
                <div class="list-group list-group-flush">
                    {% for alert in alerts %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <small>{{ alert.timestamp|datetime('%H:%M:%S') }}</small><br>
                                <small class="text-muted">{{ alert.timestamp|datetime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="col-md-2">
                                {{ alert.patient.name }}<br>
                                <small class="text-muted">Room {{ alert.patient.room }}</small>
                            </div>
                            <div class="col-md-2">
                                {% if alert.vital_type == 'heart_rate' %}
                                    Heart Rate
                                {% elif alert.vital_type == 'spo2' %}
                                    SpO₂
                                {% elif alert.vital_type == 'temp' %}
                                    Temperature
                                {% else %}
                                    {{ alert.vital_type }}
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <span class="vital-warning">
                                    {% if alert.vital_type == 'heart_rate' %}
                                        {{ alert.value|int }} bpm
                                    {% elif alert.vital_type == 'spo2' %}
                                        {{ alert.value|round(1) }}%
                                    {% elif alert.vital_type == 'temp' %}
                                        {{ alert.value|round(1) }}°C
                                    {% else %}
                                        {{ alert.value }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="col-md-2">
                                {{ alert.threshold }}
                            </div>
                            <div class="col-md-2">
                                <a href="/acknowledge-alert/{{ alert.id }}" class="btn btn-sm btn-outline-dark">Acknowledge</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No alerts found</p>
                </div>
            {% endif %}
        </div>
        
        <div class="card-footer text-center">
            <p class="text-muted mb-0">
                <small id="last-update">Last updated: {{ now|datetime }}</small><br>
                <small>Updates automatically in real-time</small>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to update the alerts when new data is available
    function updateAlerts() {
        // Show updating message
        document.getElementById('last-update').textContent = 'Updating alerts...';
        
        // Visual indicator for update in progress
        const alertsContainer = document.getElementById('alerts-container');
        alertsContainer.style.transition = 'opacity 0.3s';
        alertsContainer.style.opacity = '0.7';
        
        fetch('/alerts')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newAlertsContent = doc.getElementById('alerts-container');
                
                if (newAlertsContent) {
                    document.getElementById('alerts-container').innerHTML = newAlertsContent.innerHTML;
                    
                    // Update the alert count
                    const alertCount = doc.getElementById('alert-count').textContent;
                    document.getElementById('alert-count').textContent = alertCount;
                    
                    // Update the last updated time
                    document.getElementById('last-update').textContent = `Last updated: ${new Date().toLocaleString()}`;
                    
                    // Restore opacity with slight delay for visual feedback
                    setTimeout(() => {
                        alertsContainer.style.opacity = '1';
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Error updating alerts:', error);
                document.getElementById('last-update').textContent = 'Error updating alerts. Will retry.';
                alertsContainer.style.opacity = '1';
            });
    }

    // Update alerts periodically
    const updateInterval = 15000;
    setInterval(updateAlerts, updateInterval);
    
    // Initial update after page load
    setTimeout(updateAlerts, 1000);
</script>
{% endblock %} 